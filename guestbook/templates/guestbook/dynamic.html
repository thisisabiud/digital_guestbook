{% extends "guestbook/base.html" %}
{% block title %}Guestbook Messages{% endblock %}

{% block styles %}
<style>
    .w-full.mx-auto.p-0 {
        margin-top: 2rem;
        padding: 1rem;
    }

    .scroll-container {
        overflow: hidden;
        position: relative;
        width: 100%;
        margin-bottom: 2rem;
        padding: 0;
        transform: translateZ(0);
        contain: content;
    }

    .scroll-content {
        display: flex;
        white-space: nowrap;
        margin: 0;
        padding: 0;
        transform: translateZ(0);
        backface-visibility: hidden;
    }

    /* Modified animation calculations to prevent overlap */
    .scroll-rtl.speed-normal .scroll-content {
        animation: scrollRTL 40s linear infinite;
    }

    .scroll-ltr.speed-fast .scroll-content {
        animation: scrollLTR 30s linear infinite;
    }

    .scroll-rtl.speed-slow .scroll-content {
        animation: scrollRTL 50s linear infinite;
    }

    /* Updated keyframes with proper calculations */
    @keyframes scrollRTL {
        0% { transform: translate3d(0, 0, 0); }
        100% { transform: translate3d(-50%, 0, 0); }
    }

    @keyframes scrollLTR {
        0% { transform: translate3d(-50%, 0, 0); }
        100% { transform: translate3d(0, 0, 0); }
    }

    .card-group {
        display: inline-flex;
        gap: 1.5rem;
        padding: 0 0.75rem; /* Added padding to prevent edge touching */
        transform: translateZ(0);
        contain: content;
        flex-shrink: 0; /* Prevent cards from shrinking */
    }

    .card {
        width: 24rem;
        height: 18rem;
        border-radius: 1.5rem;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        contain: content;
        transform: translateZ(0);
        backface-visibility: hidden;
        flex-shrink: 0; /* Prevent cards from shrinking */
    }

    .card::before {
        content: '';
        position: absolute;
        inset: 0;
        z-index: 1;
        opacity: 0.15;
    }

    .card:nth-child(4n+1)::before {
        background: linear-gradient(45deg, #FF6B6B, #FFE66D);
    }

    .card:nth-child(4n+2)::before {
        background: linear-gradient(45deg, #4ECDC4, #556270);
    }

    .card:nth-child(4n+3)::before {
        background: linear-gradient(45deg, #6C5B7B, #C06C84);
    }

    .card:nth-child(4n+4)::before {
        background: linear-gradient(45deg, #45B649, #DCE35B);
    }

    .card:hover {
        transform: translate3d(0, -10px, 0);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
    }

    .card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: brightness(105%) contrast(105%);
        transition: transform 0.3s ease;
        position: relative;
        z-index: 2;
        contain: paint;
    }

    .card:hover img {
        transform: scale3d(1.05, 1.05, 1);
    }

    .scroll-container:hover .scroll-content {
        animation-play-state: paused !important;
    }

    @media (prefers-reduced-motion: reduce) {
        .scroll-content {
            animation: none !important;
        }
        .card:hover {
            transform: none;
        }
        .card:hover img {
            transform: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="w-full mx-auto p-0">
    <!-- Row 1: RTL - Normal Speed -->
    <div class="scroll-container scroll-rtl speed-normal">
        <div class="scroll-content">
            {% with visible_cards=messages%} 
                {% for _ in "12" %}  <!-- Reduced to 2 repetitions -->
                <div class="card-group">
                    {% for message in visible_cards %}
                    <div class="card">
                        <img 
                            src="{{ message.signature_base64 }}"
                            alt="Guest message {{ forloop.counter }}"
                            loading="lazy"
                            decoding="async"
                            width="384"
                            height="288"
                            fetchpriority="{% if forloop.parentloop.first and forloop.first %}high{% else %}low{% endif %}"
                        >
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            {% endwith %}
        </div>
    </div>

    <!-- Row 2: LTR - Fast Speed -->
    <div class="scroll-container scroll-ltr speed-fast">
        <div class="scroll-content">
            {% with visible_cards=messages %}
                {% for _ in "12" %}  <!-- Reduced to 2 repetitions -->
                <div class="card-group">
                    {% for message in visible_cards %}
                    <div class="card">
                        <img 
                            src="{{ message.signature_base64 }}"
                            alt="Guest message {{ forloop.counter|add:"20" }}"
                            loading="lazy"
                            decoding="async"
                            width="384"
                            height="288"
                            fetchpriority="low"
                        >
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            {% endwith %}
        </div>
    </div>

    <!-- Row 3: RTL - Slow Speed -->
    <div class="scroll-container scroll-rtl speed-slow">
        <div class="scroll-content">
            {% with visible_cards=messages %}
                {% for _ in "12" %}  <!-- Reduced to 2 repetitions -->
                <div class="card-group">
                    {% for message in visible_cards %}
                    <div class="card">
                        <img 
                            src="{{ message.signature_base64 }}"
                            alt="Guest message {{ forloop.counter|add:"40" }}"
                            loading="lazy"
                            decoding="async"
                            width="384"
                            height="288"
                            fetchpriority="low"
                        >
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            {% endwith %}
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const reloadInterval = 5 * 60 * 1000; // 5 minutes in milliseconds
        setInterval(() => {
            console.log('Reloading page...');
            location.reload();
        }, reloadInterval);
        
    const containers = document.querySelectorAll('.scroll-container');
    let observerTimeout;
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const container = entry.target;
                clearTimeout(observerTimeout);
                observerTimeout = setTimeout(() => {
                    requestAnimationFrame(() => {
                        const images = container.querySelectorAll('img[loading="lazy"]');
                        for (let i = 0; i < Math.min(images.length, 10); i++) {
                            images[i].loading = 'eager';
                        }
                    });
                }, 100);
            }
        });
    }, {
        rootMargin: '50px',
        threshold: [0.1, 0.5]
    });
    
    containers.forEach(container => {
        observer.observe(container);
        
        container.addEventListener('mouseenter', () => {
            requestAnimationFrame(() => {
                container.style.willChange = 'transform';
            });
        }, { passive: true });
        
        container.addEventListener('mouseleave', () => {
            requestAnimationFrame(() => {
                container.style.willChange = 'auto';
            });
        }, { passive: true });
    });

    window.addEventListener('unload', () => {
        clearTimeout(observerTimeout);
        observer.disconnect();
    }, { passive: true });
});
</script>
{% endblock %}
{% endblock %}